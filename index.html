<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Visopti</title>
    <link rel="icon" href="data:,">
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  </head>
  <body>
    <div id="app">
      <div id="workspace" class="is-unlocked">
        <div id="mapView" class="stage-layer"></div>
        <div id="threeView" class="stage-layer" aria-hidden="true"></div>
        <canvas id="mainCanvas" class="stage-layer" width="800" height="600"></canvas>
        <div id="mapStatus" class="map-status">Frame unlocked: pan/zoom to set a new reference.</div>
        <div id="statusOverlay">Loading…</div>
        <div id="threeViewFallback" class="three-fallback hidden"></div>
        <div
          id="structurePreviewWidget"
          role="button"
          tabindex="0"
          aria-label="Open structure editor"
        >
          <canvas id="structurePreviewCanvas" width="200" height="200"></canvas>
        </div>
      </div>
      
      <section id="controls">
        <h2>Workflow Steps</h2>
        <ol class="workflow-steps">
          <li class="workflow-step" data-step="location">
            <h3>1) Location</h3>
            <form id="addressForm" class="address-bar" role="search">
              <input
                id="addressInput"
                type="search"
                name="address"
                placeholder="Search address or place"
                aria-label="Search address"
                autocomplete="street-address"
                enterkeyhint="search"
              />
              <button id="addressGo" type="submit">Search</button>
            </form>
            <button id="btnUseMapCenter" type="button" class="link-button">
              Use current map center
            </button>
          </li>
          <li class="workflow-step" data-step="frame">
            <h3>2) Frame</h3>
            <div class="control-buttons">
              <button id="btnSetFrame" class="primary" type="button">Set frame</button>
              <button id="btnResetFrame" type="button">Reset frame</button>
            </div>
            <div class="frame-readout">
              <div class="value-row">
                <span>Width</span>
                <span id="frameWidthValue">--</span>
              </div>
              <div class="value-row">
                <span>Height</span>
                <span id="frameHeightValue">--</span>
              </div>
              <div class="value-row">
                <span>Approx area</span>
                <span id="frameAreaValue">--</span>
              </div>
              <div id="frameStatus" class="status-line">No draft frame yet.</div>
            </div>
          </li>
          <li class="workflow-step" data-step="lock">
            <h3>3) Lock</h3>
            <div class="control-buttons">
              <button id="btnLockFrame" class="primary" type="button">Lock frame</button>
              <button id="btnUnlockFrame" type="button" disabled>Edit frame</button>
            </div>
            <p class="hint">Terrain loads automatically after lock.</p>
            <div class="control-buttons">
              <button id="btnLoadTopography" type="button">Load terrain (optional)</button>
            </div>
          </li>
          <li class="workflow-step" data-step="traffic">
            <h3>4) Traffic</h3>
            <div class="control-buttons">
              <button id="btnComputeTraffic" class="primary" type="button">
                Compute simulated traffic
              </button>
              <button id="btnRecomputeTraffic" type="button" disabled>Recompute traffic</button>
            </div>
            <div id="trafficProgress" class="progress-row hidden">
              <div class="progress-header">
                <div id="trafficProgressLabel">Simulating…</div>
                <button id="btnCancelTraffic" type="button">Cancel</button>
              </div>
              <progress id="trafficProgressBar" max="1" value="0"></progress>
            </div>
            <div id="trafficStatus" class="status-line hidden"></div>
            <div class="panel">
              <label>Traffic profile
                <select id="trafficPreset">
                  <option value="neutral" selected>Standard</option>
                  <option value="am">Morning Rush</option>
                  <option value="pm">Afternoon Rush</option>
                </select>
              </label>
              <label id="trafficHourRow">Representative time
                <input id="trafficHour" type="range" min="6" max="20" step="1" value="12" />
              </label>
              <div id="trafficHourValue" class="value-row">12:00</div>
              <div id="trafficWindowHint" class="value-row hidden"></div>
              <label>Detail level
                <input id="trafficDetail" type="range" min="1" max="5" step="1" value="3" />
              </label>
              <div id="trafficDetailValue" class="value-row">Detail 3</div>
              <label class="checkbox-row">
                <input id="toggleTrafficOverlay" type="checkbox" checked />
                Show traffic overlay
              </label>
              <label class="checkbox-row">
                <input id="toggleDirectionArrows" type="checkbox" />
                Show direction arrows
              </label>
              <label>Flow density
                <select id="trafficFlowDensity">
                  <option value="low">Low</option>
                  <option value="medium" selected>Med</option>
                  <option value="high">High</option>
                </select>
              </label>
            </div>
          </li>
          <li class="workflow-step" data-step="structure">
            <h3>5) Structure</h3>
            <div class="panel">
              <label>Structure height (ft)
                <input id="structureHeight" type="number" value="30" min="1" step="1" />
              </label>
              <label>Footprint width (ft)
                <input id="structureWidth" type="number" value="60" min="1" step="1" />
              </label>
              <label>Footprint length (ft)
                <input id="structureLength" type="number" value="90" min="1" step="1" />
              </label>
              <label class="checkbox-row">
                <input id="structureCentered" type="checkbox" checked />
                Place at frame center
              </label>
            </div>
            <div class="panel structure-analysis">
              <label class="checkbox-row">
                <input id="structureSquareToRoad" type="checkbox" />
                Square to road
              </label>
              <label>Prioritize face
                <select id="structureFacePriority">
                  <option value="">None</option>
                </select>
              </label>
              <div class="value-row">
                <span>Best score</span>
                <span id="structureBestScore">--</span>
              </div>
              <div class="value-row">
                <span>Best rotation</span>
                <span id="structureBestRotation">--</span>
              </div>
              <div id="structureFaceScores" class="structure-face-scores">
                <div class="hint">Run optimization to see face ranking.</div>
              </div>
            </div>
          </li>
          <li class="workflow-step" data-step="candidates">
            <h3>6) Candidate regions</h3>
            <div class="panel">
              <div id="toolButtons" class="button-grid">
                <button data-tool="select" class="active">Select</button>
                <button data-tool="erase">Erase</button>
                <button data-tool="drawViewerPolygon">Viewer Poly</button>
                <button data-tool="drawCandidatePolygon">Candidate Poly</button>
                <button data-tool="drawObstaclePolygon">Obstacle Poly</button>
                <button data-tool="drawObstacleEllipse">Obstacle Ellipse</button>
                <button data-tool="drawDenseCoverPolygon">Dense Cover Poly</button>
              </div>
            </div>
            <div id="candidateList" class="panel">
              <button id="btnAddCandidate" class="primary">Add candidate polygon</button>
              <div class="value-row">
                <span>Candidate regions</span>
                <span id="candidateCount">0</span>
              </div>
              <div id="candidateItems" class="candidate-items">
                <div class="hint">No candidate regions yet.</div>
              </div>
            </div>
          </li>
          <li class="workflow-step" data-step="optimize">
            <h3>7) Optimization</h3>
            <div class="control-buttons">
              <button id="btnRunOptimization" class="primary" type="button">
                Run optimization
              </button>
            </div>
            <div id="optimizationProgress" class="progress-row hidden">
              <div class="progress-header">
                <div id="optimizationProgressLabel">Preparing…</div>
                <button id="btnCancelOptimization" type="button">Cancel</button>
              </div>
              <progress id="optimizationProgressBar" max="1" value="0"></progress>
            </div>
          </li>
        </ol>

        <div id="lockedInspectPanel" class="panel locked-only">
          <h3>View</h3>
          <div class="panel view-toggle-panel">
            <label class="checkbox-row">
              <input id="toggle3dView" type="checkbox" />
              3D View
            </label>
            <button id="btnReturn2d" type="button" class="hidden">Return to 2D</button>
          </div>
          <h3>Layers</h3>
          <div class="layer-grid">
            <label class="checkbox-row">
              <input id="layerRoads" type="checkbox" checked />
              Roads
            </label>
            <label class="checkbox-row">
              <input id="layerBuildings" type="checkbox" checked />
              Buildings
            </label>
            <label class="checkbox-row">
              <input id="layerTrees" type="checkbox" checked />
              Trees
            </label>
            <label class="checkbox-row">
              <input id="layerSigns" type="checkbox" checked />
              Signs
            </label>
            <label class="checkbox-row">
              <input id="layerCandidates" type="checkbox" checked />
              Candidates
            </label>
            <label class="checkbox-row">
              <input id="layerTraffic" type="checkbox" checked />
              Traffic
            </label>
          </div>
          <h3>Obstacles</h3>
          <div class="panel obstacle-panel">
            <div id="obstacleToolButtons" class="button-grid">
              <button id="btnAddTreeDeciduous" type="button">Add Tree (Deciduous)</button>
              <button id="btnAddTreePine" type="button">Add Tree (Pine)</button>
              <button id="btnAddSign" type="button">Add Billboard/Sign</button>
            </div>
            <label class="checkbox-row">
              <input id="toggleInspectMode" type="checkbox" />
              Inspect/Select
            </label>
          </div>
          <div class="panel inspect-panel">
            <div id="inspectEmpty" class="hint">Click a feature to inspect.</div>
            <div id="inspectGenericDetails" class="hidden">
              <div class="value-row">
                <span>Selected</span>
                <span id="inspectFeatureLabel">--</span>
              </div>
            </div>
            <div id="inspectBuildingDetails" class="hidden">
              <div class="value-row">
                <span>Building</span>
                <span id="inspectBuildingId">--</span>
              </div>
              <div class="value-row">
                <span>Effective height</span>
                <span id="inspectEffectiveHeight">--</span>
              </div>
              <div class="value-row">
                <span>Inferred height</span>
                <span id="inspectInferredHeight">--</span>
              </div>
              <div class="value-row">
                <span>Source</span>
                <span id="inspectHeightSource">--</span>
              </div>
              <div class="value-row">
                <span>Confidence</span>
                <span id="inspectHeightConfidence">--</span>
              </div>
              <label>Override height (ft)
                <input id="inspectHeightFeet" type="number" min="0" step="0.1" />
              </label>
              <button id="inspectResetHeight" type="button">Reset to inferred</button>
            </div>
            <div id="inspectTreeDetails" class="hidden">
              <div class="value-row">
                <span>Tree</span>
                <span id="inspectTreeId">--</span>
              </div>
              <label>Type
                <select id="inspectTreeType">
                  <option value="deciduous">Deciduous</option>
                  <option value="pine">Pine</option>
                </select>
              </label>
              <label>Base radius (m)
                <input id="inspectTreeRadius" type="number" min="0" step="0.1" />
              </label>
              <div class="value-row">
                <span>Derived height</span>
                <span id="inspectTreeDerivedHeight">--</span>
              </div>
              <label>Override height (m)
                <input id="inspectTreeHeightMeters" type="number" min="0" step="0.1" />
              </label>
              <label>Override height (ft)
                <input id="inspectTreeHeightFeet" type="number" min="0" step="0.1" />
              </label>
              <button id="inspectTreeResetHeight" type="button">Reset to derived</button>
            </div>
            <div id="inspectSignDetails" class="hidden">
              <div class="value-row">
                <span>Sign</span>
                <span id="inspectSignId">--</span>
              </div>
              <label>Kind
                <select id="inspectSignKind">
                  <option value="sign">Sign</option>
                  <option value="billboard">Billboard</option>
                </select>
              </label>
              <label>Width (m)
                <input id="inspectSignWidth" type="number" min="0" step="0.1" />
              </label>
              <label>Height (m)
                <input id="inspectSignHeight" type="number" min="0" step="0.1" />
              </label>
              <label>Bottom clearance (m)
                <input id="inspectSignClearance" type="number" min="0" step="0.1" />
              </label>
              <label>Yaw (deg)
                <input id="inspectSignYaw" type="number" step="1" />
              </label>
              <button id="inspectSignResetHeight" type="button">Reset height to default</button>
            </div>
          </div>
        </div>

        <details class="advanced-section" id="advancedPanel">
          <summary>Advanced</summary>
          <div class="details-body">
            <h2>Map &amp; Terrain</h2>
            <label>Basemap
              <select id="basemapStyle">
                <option value="street">Street</option>
                <option value="satellite">Satellite</option>
                <option value="autoStreet">Auto street</option>
              </select>
            </label>
            <label class="checkbox-row">
              <input id="toggleImageryBackground" type="checkbox" />
              Show imagery background
            </label>
            <div id="basemapWarning" class="status-line hidden"></div>

            <h2>Analysis</h2>
            <label>Target height (ft)
              <input id="siteHeight" type="number" value="6" min="1" />
            </label>
            <label>Viewer height (ft)
              <input id="viewerHeight" type="number" value="6" min="1" />
            </label>
            <label>View distance (ft)
              <input id="viewDistance" type="number" value="2000" min="0" step="50" />
            </label>
            <label>Topography sample spacing (ft)
              <input id="topoSpacing" type="number" value="25" min="5" step="1" />
            </label>
            <label>Sample step (px)
              <input id="sampleStep" type="number" value="5" min="1" />
            </label>
            <label>Dense cover density
              <select id="denseCoverDensity">
                <option value="0.3">Light (0.3)</option>
                <option value="0.6">Medium (0.6)</option>
                <option value="0.9">Heavy (0.9)</option>
              </select>
            </label>
            <label>Forest attenuation k
              <input id="forestK" type="number" min="0" step="0.01" value="0.04" />
            </label>

            <details class="advanced-section">
              <summary>Roads &amp; Traffic</summary>
              <div class="details-body">
                <h3>Mode</h3>
                <div class="toggle-group">
                  <label class="toggle-option">
                    <input id="modeAuto" type="radio" name="roadMode" value="auto" checked />
                    Auto mode
                  </label>
                  <label class="toggle-option">
                    <input id="modeCustom" type="radio" name="roadMode" value="custom" />
                    Custom mode
                  </label>
                </div>

                <h3>Auto data</h3>
                <div class="control-buttons">
                  <button id="btnAutoPopulate" class="primary">Auto-populate roads/buildings</button>
                  <button id="btnRefreshAuto">Refresh auto data</button>
                </div>
                <div id="autoDataStatus" class="status-line">No auto data yet.</div>
                <div id="simulationExtentStatus" class="status-line">Simulation extent: --</div>
                <label class="checkbox-row">
                  <input id="toggleFetchOsmObstacles" type="checkbox" />
                  Fetch OSM obstacles (trees, billboards, signals)
                </label>

                <h3>Epicenter</h3>
                <div class="control-buttons">
                  <button id="btnPickEpicenter">Manual epicenter override</button>
                </div>
                <label>Radius (m)
                  <input id="epicenterRadius" type="range" min="50" max="5000" step="50" value="800" />
                </label>
                <div class="value-row">
                  <span id="epicenterRadiusValue">800 m</span>
                  <span id="epicenterStatus">No epicenter set</span>
                </div>
                <label>Centralized share (0-1)
                  <input id="trafficCentralShare" type="number" min="0" max="1" step="0.05" value="0.6" />
                </label>
                <p class="hint">Share of trips biased toward epicenters.</p>

                <h3>Road tools</h3>
                <div id="customRoadControls" class="control-buttons">
                  <button id="btnAddRoad">Add custom road</button>
                  <button id="btnEditRoad">Edit selected road</button>
                  <button id="btnDeleteRoad">Delete selected road</button>
                </div>
                <p id="customRoadHint" class="hint">Custom mode required for add/edit/delete.</p>
                <div id="roadProperties" class="panel hidden">
                  <label>Name (optional)
                    <input id="roadName" type="text" placeholder="Road name" />
                  </label>
                  <label>One-way
                    <select id="roadDirection">
                      <option value="both">Both</option>
                      <option value="forward">Forward</option>
                      <option value="backward">Backward</option>
                    </select>
                  </label>
                  <label class="checkbox-row">
                    <input id="roadShowCenterline" type="checkbox" />
                    Show direction line
                  </label>
                  <label>Cars/hour forward
                    <input id="roadCarsForward" type="number" min="0" step="50" />
                  </label>
                  <label>Cars/hour backward
                    <input id="roadCarsBackward" type="number" min="0" step="50" />
                  </label>
                  <p class="hint">Custom traffic fields apply to custom roads.</p>
                </div>
              </div>
            </details>
          </div>
        </details>

        <details class="advanced-section" id="debugPanel">
          <summary>Debug</summary>
          <div class="details-body">
            <h2>Diagnostics</h2>
            <div id="debugStats" class="status-line">Mode: --</div>
            <label class="checkbox-row">
              <input id="toggleViewers" type="checkbox" checked />
              Show viewer zones
            </label>
            <label class="checkbox-row">
              <input id="toggleCandidates" type="checkbox" checked />
              Show candidate zones
            </label>
            <label class="checkbox-row">
              <input id="toggleObstacles" type="checkbox" checked />
              Show obstacle zones
            </label>
            <label class="checkbox-row">
              <input id="toggleContours" type="checkbox" />
              Topography contours
            </label>

            <h2>Export &amp; Import</h2>
            <button id="btnExportProject">Export project JSON</button>
            <label class="import-label">Import project JSON
              <input id="importFile" type="file" accept="application/json" />
            </label>
            <button id="btnExportShapes">Export shapes JSON</button>
            <label class="import-label">Import shapes JSON
              <input id="importShapesFile" type="file" accept="application/json" />
            </label>

            <h2>ML Labeling</h2>
            <label class="checkbox-row">
              <input id="toggleLabelingMode" type="checkbox" />
              Labeling mode
            </label>
            <div id="labelToolButtons" class="button-grid">
              <button type="button" data-tool="labelTreeDeciduous">Label Tree (Deciduous)</button>
              <button type="button" data-tool="labelTreePine">Label Tree (Pine)</button>
              <button type="button" data-tool="labelSign">Label Sign</button>
              <button type="button" data-tool="labelBillboard">Label Billboard</button>
            </div>
            <div class="control-buttons">
              <button id="btnExportLabels" type="button">Export labels JSON</button>
              <label class="import-label">Import predictions JSON
                <input id="importPredictionsFile" type="file" accept="application/json" />
              </label>
              <label class="import-label">Import ML trees/signs
                <input id="importMlTreesFile" type="file" accept="application/json" />
              </label>
              <button id="btnClearPredictions" type="button">Clear predictions</button>
              <button id="btnDetectMlFrame" type="button">ML: Detect trees in frame (beta)</button>
            </div>
            <div id="labelStatus" class="status-line">Labels: 0 · Predictions: 0</div>
          </div>
        </details>

        <div id="warningBanner" class="hidden"></div>
        <div id="statusMessage"></div>
      </section>
    </div>

    <div
      id="structureEditorModal"
      class="structure-editor-modal hidden"
      role="dialog"
      aria-modal="true"
      aria-hidden="true"
      aria-labelledby="structureEditorTitle"
    >
      <div class="structure-editor-shell" role="document">
        <header class="structure-editor-header">
          <div>
            <h2 id="structureEditorTitle">Structure Editor</h2>
            <p class="hint">
              Draw a footprint, drag vertices to edit, or pick a front edge for the arc.
            </p>
          </div>
          <button id="structureEditorClose" type="button" class="link-button">
            Close
          </button>
        </header>
        <div class="structure-editor-body">
          <div class="structure-editor-stage">
            <canvas id="structureEditorCanvas" width="900" height="640"></canvas>
            <div class="structure-editor-note">Shift snaps rotation to 15 deg.</div>
          </div>
          <aside class="structure-editor-panel panel">
            <div class="structure-editor-tabs">
              <button
                type="button"
                class="tab-button is-active"
                data-structure-tab="parametric"
              >
                Shape
              </button>
              <button type="button" class="tab-button" data-structure-tab="imported">
                Import
              </button>
            </div>
            <div class="structure-editor-tab-panel is-active" data-structure-panel="parametric">
              <section class="structure-editor-section">
                <h3>Tools</h3>
                <div class="structure-editor-tool-row">
                  <button type="button" class="tool-button is-active" data-mode="select">Select</button>
                  <button type="button" class="tool-button" data-mode="draw_polygon">Draw</button>
                  <button type="button" class="tool-button" data-mode="edit_vertices">Edit</button>
                  <button type="button" class="tool-button" data-mode="move">Move</button>
                  <button type="button" class="tool-button" data-mode="rotate">Rotate</button>
                  <button type="button" class="tool-button" data-mode="face_priority">Face</button>
                </div>
                <p class="hint">Click points, double-click to finish a footprint.</p>
              </section>
              <section class="structure-editor-section">
                <h3>Footprint</h3>
                <div class="value-row">
                  <span>Perimeter</span>
                  <span id="structureEditorPerimeterValue">--</span>
                </div>
                <div class="value-row">
                  <span>Area</span>
                  <span id="structureEditorAreaValue">--</span>
                </div>
              </section>
              <section class="structure-editor-section">
                <h3>Height</h3>
                <label>Height (ft)
                  <input id="structureEditorHeight" type="number" min="1" step="1" />
                </label>
                <input
                  id="structureEditorHeightSlider"
                  class="structure-editor-slider"
                  type="range"
                  min="1"
                  max="500"
                  step="1"
                />
              </section>
              <section class="structure-editor-section">
                <h3>Rotation</h3>
                <label>Rotation (deg)
                  <input id="structureEditorRotation" type="number" step="1" />
                </label>
              </section>
              <section class="structure-editor-section">
                <h3>Face Priority</h3>
                <div class="structure-editor-arc-row">
                  <button type="button" class="tool-button" data-arc="180">Arc 180</button>
                  <button type="button" class="tool-button" data-arc="270">Arc 270</button>
                </div>
                <div class="value-row">
                  <span>Front edge</span>
                  <span id="structureEditorFrontEdgeValue">None</span>
                </div>
              </section>
            </div>
            <div class="structure-editor-tab-panel" data-structure-panel="imported">
              <section class="structure-editor-section">
                <h3>Import</h3>
                <label class="import-label">Model file
                  <input
                    id="structureEditorImportFile"
                    type="file"
                    accept=".glb,.gltf,.obj,.stl"
                  />
                </label>
                <div class="value-row">
                  <span>Selected</span>
                  <span id="structureEditorImportName">None</span>
                </div>
                <div class="value-row">
                  <span>Format</span>
                  <span id="structureEditorImportFormat">--</span>
                </div>
                <p class="hint">GLB/GLTF/OBJ/STL supported. DXF/DWG must be converted to GLB.</p>
              </section>
              <section class="structure-editor-section">
                <h3>Transform</h3>
                <label>Scale
                  <input id="structureEditorImportScale" type="number" min="0.001" step="0.01" />
                </label>
                <label>Rotation (deg)
                  <input id="structureEditorImportRotation" type="number" step="1" />
                </label>
                <div class="structure-editor-offset-row">
                  <label>Offset X
                    <input id="structureEditorImportOffsetX" type="number" step="0.1" />
                  </label>
                  <label>Offset Y
                    <input id="structureEditorImportOffsetY" type="number" step="0.1" />
                  </label>
                  <label>Offset Z
                    <input id="structureEditorImportOffsetZ" type="number" step="0.1" />
                  </label>
                </div>
              </section>
              <section class="structure-editor-section">
                <h3>Footprint Proxy</h3>
                <button
                  id="structureEditorGenerateProxy"
                  type="button"
                  class="tool-button"
                >
                  Generate footprint proxy
                </button>
                <div class="value-row">
                  <span>Status</span>
                  <span id="structureEditorProxyStatus">None</span>
                </div>
                <p class="hint">Uses a bounding box projection onto the ground plane.</p>
              </section>
            </div>
            <div class="structure-editor-actions">
              <button id="structureEditorCancel" type="button">Cancel</button>
              <button id="structureEditorApply" type="button" class="primary">Apply</button>
            </div>
          </aside>
        </div>
      </div>
    </div>

    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
