<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Visopti</title>
    <link rel="icon" href="data:,">
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      crossorigin=""
    />
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  </head>
  <body>
    <div id="app">
      <div id="workspace">
        <div class="map-wrapper">
          <div id="mapView"></div>
          <form id="addressForm" class="address-bar" role="search">
            <input
              id="addressInput"
              type="search"
              name="address"
              placeholder="Search address or place"
              aria-label="Search address"
              autocomplete="street-address"
              enterkeyhint="search"
            />
            <button id="addressGo" type="submit">Go</button>
          </form>
          <div id="mapStatus" class="map-status">Frame unlocked: pan/zoom to set a new reference.</div>
        </div>
        <div class="canvas-wrapper">
          <canvas id="mainCanvas" width="800" height="600"></canvas>
          <div id="statusOverlay">Loading…</div>
        </div>
      </div>
      
      <section id="controls">
        <h2>Map & Terrain</h2>
        <p class="hint">
          Pan/zoom the map to set your frame, lock it, then load topography to sync the canvas.
        </p>
        <label>Basemap
          <select id="basemapStyle">
            <option value="street">Street</option>
            <option value="satellite">Satellite</option>
            <option value="autoStreet">Auto street</option>
          </select>
        </label>
        <div id="basemapWarning" class="status-line hidden"></div>
        <div class="control-buttons">
          <button id="btnLockFrame" class="primary">Lock frame</button>
          <button id="btnLoadTopography">Load topography</button>
        </div>

        <h2>Tools</h2>
        <div id="toolButtons" class="button-grid">
          <button data-tool="select" class="active">Select</button>
          <button data-tool="erase">Erase</button>
          <button data-tool="drawViewerPolygon">Viewer Poly</button>
          <button data-tool="drawCandidatePolygon">Candidate Poly</button>
          <button data-tool="drawObstaclePolygon">Obstacle Poly</button>
          <button data-tool="drawObstacleEllipse">Obstacle Ellipse</button>
        </div>

        <h2>Settings</h2>
        <label>Target height (ft)
          <input id="siteHeight" type="number" value="6" min="1" />
        </label>
        <label>Viewer height (ft)
          <input id="viewerHeight" type="number" value="6" min="1" />
        </label>
        <label>Topography sample spacing (ft)
          <input id="topoSpacing" type="number" value="25" min="5" step="1" />
        </label>
        <label>Sample step (px)
          <input id="sampleStep" type="number" value="5" min="1" />
        </label>

        <h3>Overlay visibility</h3>
        <label class="checkbox-row">
          <input id="toggleViewers" type="checkbox" checked />
          Show viewer zones
        </label>
        <label class="checkbox-row">
          <input id="toggleCandidates" type="checkbox" checked />
          Show candidate zones
        </label>
        <label class="checkbox-row">
          <input id="toggleObstacles" type="checkbox" checked />
          Show obstacle zones
        </label>
        <label class="checkbox-row">
          <input id="toggleContours" type="checkbox" />
          Topography contours
        </label>

        <h3>Opacity</h3>
        <label>Viewer opacity
          <input id="viewerOpacity" type="range" min="0" max="1" step="0.05" value="0.6" />
        </label>
        <label>Candidate opacity
          <input id="candidateOpacity" type="range" min="0" max="1" step="0.05" value="0.6" />
        </label>
        <label>Obstacle opacity
          <input id="obstacleOpacity" type="range" min="0" max="1" step="0.05" value="0.85" />
        </label>
        <label>Heatmap opacity
          <input id="heatmapOpacity" type="range" min="0" max="1" step="0.05" value="0.45" />
        </label>
        <label>Shading opacity
          <input id="shadingOpacity" type="range" min="0" max="1" step="0.05" value="0.6" />
        </label>
        <label>Contour opacity
          <input id="contourOpacity" type="range" min="0" max="1" step="0.05" value="0.9" />
        </label>

        <div class="control-buttons">
          <button id="btnComputeHeatmap" class="primary">Compute heatmap</button>
          <button id="btnComputeShading">Compute blindspots</button>
          <button id="btnClearHeatmap">Clear heatmap</button>
          <button id="btnClearShading">Clear blindspots</button>
          <button id="btnClearShapes">Clear shapes</button>
        </div>

        <div id="progressContainer" class="hidden">
          <div id="progressLabel">Computing…</div>
          <progress id="computeProgress" max="1" value="0"></progress>
        </div>

        <h2>Project</h2>
        <button id="btnExportProject">Export project JSON</button>
        <label class="import-label">Import project JSON
          <input id="importFile" type="file" accept="application/json" />
        </label>
        <button id="btnExportShapes">Export shapes JSON</button>
        <label class="import-label">Import shapes JSON
          <input id="importShapesFile" type="file" accept="application/json" />
        </label>

        <details class="advanced-section">
          <summary>Roads &amp; Traffic</summary>
          <div class="details-body">
            <h3>Mode</h3>
            <div class="toggle-group">
              <label class="toggle-option">
                <input id="modeAuto" type="radio" name="roadMode" value="auto" checked />
                Auto mode
              </label>
              <label class="toggle-option">
                <input id="modeCustom" type="radio" name="roadMode" value="custom" />
                Custom mode
              </label>
            </div>

            <h3>Auto data</h3>
            <div class="control-buttons">
              <button id="btnAutoPopulate" class="primary">Auto-populate roads/buildings</button>
              <button id="btnRefreshAuto">Refresh auto data</button>
            </div>
            <div id="autoDataStatus" class="status-line">No auto data yet.</div>

            <h3>Epicenter</h3>
            <div class="control-buttons">
              <button id="btnPickEpicenter">Set epicenter by click</button>
            </div>
            <label>Radius (m)
              <input id="epicenterRadius" type="range" min="50" max="5000" step="50" value="800" />
            </label>
            <div class="value-row">
              <span id="epicenterRadiusValue">800 m</span>
              <span id="epicenterStatus">No epicenter set</span>
            </div>

            <h3>Traffic</h3>
            <label>Traffic preset
              <select id="trafficPreset">
                <option value="am">AM</option>
                <option value="pm">PM</option>
                <option value="neutral" selected>Neutral</option>
                <option value="hourly">Hourly</option>
              </select>
            </label>
            <label id="trafficHourRow" class="hidden">Hour
              <input id="trafficHour" type="range" min="0" max="23" step="1" value="8" />
            </label>
            <div id="trafficHourValue" class="value-row hidden">08:00</div>
            <label>Detail level
              <input id="trafficDetail" type="range" min="1" max="5" step="1" value="3" />
            </label>
            <div id="trafficDetailValue" class="value-row">Detail 3</div>
            <div class="control-buttons">
              <button id="btnComputeTraffic" class="primary">Compute traffic</button>
            </div>
            <label class="checkbox-row">
              <input id="toggleTrafficOverlay" type="checkbox" checked />
              Show traffic overlay
            </label>
            <label class="checkbox-row">
              <input id="toggleDirectionArrows" type="checkbox" />
              Show direction arrows
            </label>
        <div id="trafficProgress" class="progress-row hidden">
          <div class="progress-header">
            <div id="trafficProgressLabel">Simulating…</div>
            <button id="btnCancelTraffic" type="button">Cancel</button>
          </div>
          <progress id="trafficProgressBar" max="1" value="0"></progress>
        </div>
            <div id="trafficStatus" class="status-line hidden"></div>

            <h3>Road tools</h3>
            <div class="control-buttons">
              <button id="btnAddRoad">Add custom road</button>
              <button id="btnEditRoad">Edit selected road</button>
              <button id="btnDeleteRoad">Delete selected road</button>
            </div>
            <div id="roadProperties" class="panel hidden">
              <label>Name (optional)
                <input id="roadName" type="text" placeholder="Road name" />
              </label>
              <label>One-way
                <select id="roadDirection">
                  <option value="both">Both</option>
                  <option value="forward">Forward</option>
                  <option value="backward">Backward</option>
                </select>
              </label>
              <label class="checkbox-row">
                <input id="roadShowCenterline" type="checkbox" />
                Show direction line
              </label>
              <label>Cars/hour forward
                <input id="roadCarsForward" type="number" min="0" step="50" />
              </label>
              <label>Cars/hour backward
                <input id="roadCarsBackward" type="number" min="0" step="50" />
              </label>
              <p class="hint">Custom roads only.</p>
            </div>
          </div>
        </details>

        <div id="warningBanner" class="hidden"></div>
        <div id="statusMessage"></div>
      </section>
    </div>

    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
